<html>
	<head>
		<title>Model TEST</title>
		<script src = "irrigation_canal_model.js"></script>
		<script src = "my_lib.js"></script>
		<script>
			var OMVC = {};

			function onModelLoaded(str) {
				OMVC.model = new Model(str);
				//console.log(OMVC.model);
			};

			
			function inputFileOnchange(event) {
				var file = event.target.files[0];

				if (!file) return;
				
				{
					var reader = new FileReader();
					reader.onload = function() {
						onModelLoaded(reader.result);
					};
					reader.readAsText(file);
				}

				var message = "model loaded from file '" + file.name + "'";
				console.log(message);
				alert(message);
			};

			//------------------------------------------

			// function loadedModelFromFile(path) {
			// 	var rawFile = new XMLHttpRequest();
			// 	rawFile.open("GET", path, true);
			// 	rawFile.onreadystatechange = function () {
			// 		if(rawFile.readyState === 4 && (rawFile.status === 200 || rawFile.status == 0)) {
			// 			onModelLoaded(rawFile.responseText);
			// 		}
			// 	}
			// 	rawFile.send(null);
			// };

			// //"file:///home/sahlet/Documents/5_course/complex_systems_lab/model_stringify_1.JSON"
			// //"model_stringify_1.JSON"
			// //chrome.exe --allow-file-access-from-files
			// loadedModelFromFile("model_stringify_1.JSON");

			// Function to download data to a file

			//------------------------------------------

			function saveModel() {
				var default_filename = "model_stringify.JSON";

				var blob = new Blob([JSON.stringify(OMVC.model)], {type : "application/json"});
				if (window.navigator.msSaveOrOpenBlob) { // IE10+
					window.navigator.msSaveOrOpenBlob(blob, default_filename);
				} else { // Others
					var a = document.createElement("a");
					var url = URL.createObjectURL(blob);
					a.href = url;
					a.download = default_filename;
					document.body.appendChild(a);
					a.click();
					
					setTimeout(function() {
						document.body.removeChild(a);
						window.URL.revokeObjectURL(url);
					}, 0);
				}
			}

			function waterLevelOnChange(waterLevel, Model) {
				var currentTonel = Model.content;
				currentTonel.changeWaterLevel(waterLevel);
			}

			function engineWorksOnChange(engineWorks, Model) {
				var currentTonel = Model.content;
				currentTonel.changeEngineWorks(engineWorks);
			}

			function addObservers(model) {
				if(model == null) { return; }

				var tonel = /* new Tonel() */ {
					changeWaterLevel : function(waterLevel) {}
					changeEngineWorks : function(engineWorks) {}
					addChildTonel : function(childTonel) {}
				};

				model.content = tonel;

				if (model.parent != null) {
					model.parent.content.addChildTonel(tonel);
				}

				model.waterLevelOnChange.addObserver(waterLevelOnChange);
				model.engineWorksOnChange.addObserver(engineWorksOnChange);

				for(child in model.children) {
					addObservers(child);
				}
			}

		</script>
	</head>
	<body>
		<button for = "input_file", onclick = "document.getElementById('input_file').click()">
			Load model
		</button>
		<input
			id = "input_file" type = "file",
			accept = ".JSON",
			onchange = "inputFileOnchange(event);",
			style = "visibility : hidden;"
		/>
		<br>
		<br>
		If you want change model parameters (not only waterLevel), you can use some editor (you should create it).
		<br>
		<br>
		<button id = "save_model", onclick = "saveModel()">
			Save model
		</button>
	</body>
</html>
